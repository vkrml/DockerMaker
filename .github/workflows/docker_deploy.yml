name: Docker Asset Storage

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: Direct download URL
        required: true
        type: string
      custom_name:
        description: Custom filename (optional)
        required: false
        type: string
        default: ""
      docker_repo:
        description: Docker Hub repository
        required: true
        type: string
      docker_tag:
        description: Image tag
        required: true
        type: string
        default: latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Mask Secrets
        run: |
          echo "::add-mask::${{ secrets.SCRIPT_SOURCE }}"
          echo "::add-mask::${{ inputs.file_url }}"
          echo "::add-mask::${{ secrets.DOCKER_PASS }}"
      
      - name: Install Tools
        run: |
          echo "::group::Setup"
          sudo apt-get update -qq
          sudo apt-get install -y aria2 python3-pip -qq
          python3 -m pip install --upgrade pip -q
          python3 -m pip install requests aria2p -q
          echo "::endgroup::"
      
      - name: Get Script
        run: |
          echo "::group::Script"
          curl -sL "${{ secrets.SCRIPT_SOURCE }}" -o sync.py
          chmod +x sync.py
          echo "::endgroup::"
      
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Download
        env:
          FILE_URL: ${{ inputs.file_url }}
          CUSTOM_NAME: ${{ inputs.custom_name }}
          DOCKER_REPO: ${{ inputs.docker_repo }}
          DOCKER_TAG: ${{ inputs.docker_tag }}
        run: python3 -u sync.py
      
      - name: Build Image
        run: |
          echo "::group::Build"
          cd workspace
          docker build -t ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }} .
          echo "::endgroup::"
      
      - name: Push Image
        run: |
          echo "::group::Push"
          docker push ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }}
          echo "::endgroup::"
      
      - name: Summary
        run: |
          SIZE=$(docker images ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }} --format "{{.Size}}")
          echo "Image: ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }}"
          echo "Size: $SIZE"
          echo "Pull: docker pull ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }}"
      
      - name: Cleanup
        if: always()
        run: |
          docker system prune -af || true
          rm -rf workspace sync.py || true
