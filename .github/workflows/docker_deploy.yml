name: Docker Asset Storage Bridge

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'Direct download link'
        required: true
        type: string
      custom_name:
        description: 'Custom filename (optional)'
        required: false
        type: string
        default: ''
      docker_repo:
        description: 'Docker Hub repository'
        required: true
        type: string
      docker_tag:
        description: 'Image tag'
        required: true
        type: string
        default: 'latest'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Mask Sensitive Data
        run: |
          echo "::add-mask::${{ secrets.SCRIPT_SOURCE }}"
          echo "::add-mask::${{ inputs.file_url }}"
          echo "::add-mask::${{ secrets.DOCKER_PASS }}"
      
      - name: Setup Environment
        run: |
          echo "::group::System Preparation"
          sudo apt-get update -qq
          sudo apt-get install -y aria2 python3-pip -qq > /dev/null 2>&1
          pip3 install -q requests aria2p
          echo "::endgroup::"
      
      - name: Fetch Execution Logic
        run: |
          echo "::group::Script Retrieval"
          curl -sL "${{ secrets.SCRIPT_SOURCE }}" -o .sync.py
          chmod +x .sync.py
          echo "Logic loaded"
          echo "::endgroup::"
      
      - name: Docker Hub Authentication
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Execute Download & Preparation
        env:
          FILE_URL: ${{ inputs.file_url }}
          CUSTOM_NAME: ${{ inputs.custom_name }}
          DOCKER_REPO: ${{ inputs.docker_repo }}
          DOCKER_TAG: ${{ inputs.docker_tag }}
        run: python3 -u .sync.py
      
      - name: Build & Push Docker Image
        run: |
          echo "::group::Docker Build"
          cd workspace
          docker build --no-cache --progress=plain -t ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }} . 2>&1 | grep -E "^#|COPY|FROM|=>"
          echo "::endgroup::"
          
          echo "::group::Registry Push"
          docker push ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }}
          echo "::endgroup::"
      
      - name: Deployment Summary
        run: |
          SIZE=$(docker images ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }} --format "{{.Size}}")
          echo "✅ Image: ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }}"
          echo "✅ Size: $SIZE"
          echo "✅ Pull: docker pull ${{ secrets.DOCKER_USER }}/${{ inputs.docker_repo }}:${{ inputs.docker_tag }}"
